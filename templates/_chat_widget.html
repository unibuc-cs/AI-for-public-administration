<!-- templates/_chat_widget.html -->
<style>
  .chat-shell{
    border:1px solid #e5e7eb;
    border-radius:16px;
    background:#fff;
    display:flex;
    flex-direction:column;
    height:100%;
    overflow:hidden;
  }
  .chat-header{
    padding:10px 12px;
    background:#f8fafc;
    border-bottom:1px solid #eef2f7;
    font-weight:600;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .chat-header small{font-weight:400;color:#6b7280}
  .chat-messages{
    flex:1;
    overflow:auto;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .msg{
    max-width:min(760px, 92%);
    padding:10px 12px;
    border-radius:14px;
    border:1px solid #eef2f7;
    line-height:1.35;
    white-space:pre-wrap;
    word-break:break-word;
  }
  .msg.user{
    align-self:flex-end;
    background:#f1f5f9;
  }
  .msg.bot{
    align-self:flex-start;
    background:#ffffff;
  }
  .msg .meta{
    font-size:12px;
    color:#6b7280;
    margin-bottom:6px;
  }
  .chat-input{
    border-top:1px solid #eef2f7;
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:flex-end;
  }
  .chat-input textarea{
    flex:1;
    resize:vertical;
    min-height:44px;
    max-height:160px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #d1d5db;
    font:inherit;
  }
  .chat-input button{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #d1d5db;
    background:#fff;
    cursor:pointer;
    font-weight:600;
  }
  .chat-input button:disabled{opacity:.5;cursor:not-allowed}
  .chat-hint{
    padding:8px 12px;
    font-size:12px;
    color:#6b7280;
    border-top:1px dashed #eef2f7;
    background:#fbfdff;
  }
  .chat-hint a{color:inherit}
</style>

<div class="chat-shell">
  <div class="chat-header">
    <div>Asistent</div>
    <small>sid: <span id="chat-sid">{{ sid }}</span></small>
  </div>

  <div id="chat-log" class="chat-messages" aria-live="polite"></div>

  <div class="chat-input">
    <textarea id="chat-msg" placeholder="Scrie un mesaj… (Enter pentru trimis, Shift+Enter pentru rând nou)"></textarea>
    <button id="chat-send" type="button">Trimite</button>
  </div>

  <div class="chat-hint">
    Context: <b>{{ chat_context|default('public') }}</b> ·
    Dacă ai încărcat documente, poți scrie „am încărcat documentele”.
  </div>
</div>

<script>
(function(){
  const url = new URL(window.location.href);
  const sidParam = url.searchParams.get('sid');

  // Server provides sid or we generate a stable one for this page load.
  const sidTpl = "{{ sid|default('chat-'+ range(1000,9999)|random|string) }}";
  const sid = sidParam || sidTpl;
  window.__CHAT_SID__ = sid;
  document.getElementById('chat-sid').textContent = sid;

  const uiContext = "{{ chat_context|default('public') }}";
  const tplMode = "{{ chat_mode|default('user') }}";
  const mode = (tplMode && tplMode !== 'None') ? tplMode : (sid.startsWith('op-') ? 'operator' : 'user');

  function escapeHTML(s){
    return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function linkify(escapedText){
    // Turn http(s) and internal /user-* links into anchors.
    const re = /(https?:\/\/[^\s]+|\/(?:user-ci|user-social)\?[^\s]+)/g;
    return escapedText.replace(re, (m) => {
      const href = m.startsWith('/') ? m : m;
      return `<a href="${href}" target="${m.startsWith('http') ? '_blank' : '_self'}" rel="noopener">${m}</a>`;
    });
  }

  function append(role, msg){
    const log = document.getElementById('chat-log');
    const box = document.createElement('div');
    box.className = 'msg ' + (role==='Tu' ? 'user' : 'bot');

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = role;

    const body = document.createElement('div');
    const safe = linkify(escapeHTML(msg));
    body.innerHTML = safe;

    box.appendChild(meta);
    box.appendChild(body);
    log.appendChild(box);
    log.scrollTop = log.scrollHeight;
  }

  async function chatSend(){
    const btn = document.getElementById('chat-send');
    const msgEl = document.getElementById('chat-msg');
    const text = (msgEl.value || '').trim();
    if(!text) return;

    append('Tu', text);
    msgEl.value = '';

    btn.disabled = true;
    try{
      const r = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          session_id: sid,
          message: text,
          application: { ui_context: uiContext }
          // NOTE: do NOT send `person: {}` here.
          // `person` is an optional *structured* object in the API schema.
          // Sending an empty object triggers 422 validation errors (missing required fields).
        })
      });

      const j = await r.json();
      append('Bot', j.reply || 'OK');

      // broadcast steps so host pages can react (populate dropdowns / toast / navigation)
      const steps = j.steps || [];
      window.dispatchEvent(new CustomEvent('chat-steps', { detail: { steps, sid } }));
    }catch(e){
      append('Bot', 'Eroare la comunicare cu serverul.');
      console.error(e);
    }finally{
      btn.disabled = false;
    }
  }

  // Bind events
  document.getElementById('chat-send').addEventListener('click', chatSend);
  const msgEl = document.getElementById('chat-msg');
  msgEl.addEventListener('keydown', (ev) => {
    if(ev.key === 'Enter' && !ev.shiftKey){
      ev.preventDefault();
      chatSend();
    }
  });

  // greeting once per session
  const greetKey = 'chat:greeted:'+sid+':'+uiContext+':'+mode;
  if(!sessionStorage.getItem(greetKey)){
    const greet = (mode==='operator')
      ? 'Salut! Spune-mi ce ai nevoie (ex: „list tasks”, „claim task 12”, „advance case CASE-1 to READY_FOR_PICKUP”).'
      : 'Salut! Pot să te ghidez pentru CI sau Ajutor Social. Spune ce vrei să rezolvi.';
    append('Bot', greet);
    sessionStorage.setItem(greetKey,'1');
  }
})();
</script>
