<div class="chatwrap" id="chatwrap" data-sid="{{ sid }}" data-ui-context="{{ ui_context|default('public') }}" style="width: {{ width|default('100%') }};">
  <style>
    .chatwrap{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    .chathead{padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;background:#fafafa}
    .chathead .title{font-weight:600;font-size:14px}
    .chathead .meta{font-size:12px;color:#6b7280}
    .chatlog{padding:12px;height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:#fff}
    .msgrow{display:flex}
    .msgrow.user{justify-content:flex-end}
    .msgrow.bot{justify-content:flex-start}
    .bubble{max-width:85%;padding:10px 12px;border-radius:14px;line-height:1.35;font-size:13px;white-space:pre-wrap;word-wrap:break-word}
    .bubble.user{background:#111827;color:#fff;border-bottom-right-radius:6px}
    .bubble.bot{background:#f3f4f6;color:#111827;border-bottom-left-radius:6px}
    .chatbar{border-top:1px solid #e5e7eb;padding:10px 12px;background:#fafafa}
    .chatbar .hint{font-size:11px;color:#6b7280;margin-bottom:6px}
    .chatbar textarea{width:100%;min-height:72px;resize:vertical;border:1px solid #d1d5db;border-radius:12px;padding:10px 12px;font-size:13px;outline:none;background:#fff}
    .chatbar textarea:focus{border-color:#9ca3af;box-shadow:0 0 0 3px rgba(156,163,175,0.25)}
    .chatbar .btnrow{display:flex;justify-content:flex-end;margin-top:8px}
    .chatbar button{border:0;border-radius:12px;padding:10px 14px;font-weight:600;font-size:13px;cursor:pointer;background:#111827;color:#fff}
    .chatbar button:disabled{opacity:0.5;cursor:not-allowed}
    .chatlink{color:#2563eb;text-decoration:underline}
  </style>

  <div class="chathead">
    <div>
      <div class="title">{{ title|default('Chat') }}</div>
      <div class="meta" id="chatsub"></div>
    </div>
    <div class="meta">sid: <span id="chatsid"></span></div>
  </div>

  <div class="chatlog" id="chatlog"></div>

  <div class="chatbar">
    <div class="hint" id="chathint">Enter pentru trimis. Shift+Enter pentru rand nou.</div>
    <textarea id="chatinput" placeholder="Scrie aici..."></textarea>
    <div class="btnrow">
      <button id="chatsend" type="button">Trimite</button>
    </div>
  </div>
</div>

<script>
(function(){
  const root = document.getElementById('chatwrap');
  const sid = root.getAttribute('data-sid') || 'anon';
  const ctx = (root.getAttribute('data-ui-context') || 'public').toLowerCase();

  document.getElementById('chatsid').textContent = sid;

  const sub = document.getElementById('chatsub');
  if (ctx === 'ci') sub.textContent = 'Wizard for Identity Card (CI)';
  else if (ctx === 'social') sub.textContent = 'Wizard for Social Help (Ajutor Social)';
  else if (ctx === 'operator') sub.textContent = 'Operator console assistant';
  else sub.textContent = 'Public assistant';

  const log = document.getElementById('chatlog');
  const input = document.getElementById('chatinput');
  const btn = document.getElementById('chatsend');

  function addMsg(role, text){
    const row = document.createElement('div');
    row.className = 'msgrow ' + (role === 'user' ? 'user' : 'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'bot');

    const t = String(text || '');
    const m = t.match(/(\/user-ci\?sid=[^\s]+|\/user-social\?sid=[^\s]+)/);
    if (m){
      const url = m[0];
      const parts = t.split(url);
      bubble.textContent = parts[0];
      const a = document.createElement('a');
      a.href = url;
      a.className = 'chatlink';
      a.textContent = url;
      bubble.appendChild(a);
      bubble.appendChild(document.createTextNode(parts.slice(1).join(url)));
    } else {
      bubble.textContent = t;
    }

    row.appendChild(bubble);
    log.appendChild(row);
    log.scrollTop = log.scrollHeight;
  }

  function hasAnyValue(obj){
    if (!obj || typeof obj !== 'object') return false;
    for (const k of Object.keys(obj)){
      const v = obj[k];
      if (v === null || v === undefined) continue;
      if (typeof v === 'string' && v.trim() !== '') return true;
      if (typeof v === 'number') return true;
      if (typeof v === 'object' && hasAnyValue(v)) return true;
    }
    return false;
  }

  function getPayload(text){
    let form = {};
    try {
      if (typeof window.getFormPayload === 'function') {
        form = window.getFormPayload() || {};
      }
    } catch (e) {}

    const app = (form.application && typeof form.application === 'object') ? form.application : {};
    if (!app.ui_context) app.ui_context = ctx;

    const payload = {
      session_id: sid,
      message: text,
      application: app,
    };

    if (hasAnyValue(form.person)) payload.person = form.person;

    return payload;
  }

  async function sendText(text, opts){
    const options = opts || {};
    const msg = String(text || '').trim();
    if (!msg) return;

    if (!options.silentUser) addMsg('user', msg);

    btn.disabled = true;

    try {
      const payload = getPayload(msg);
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if (!resp.ok){
        const err = (data && (data.detail || data.error)) || ('HTTP ' + resp.status);
        addMsg('bot', 'Error: ' + err);
        return;
      }

      addMsg('bot', data.reply || 'OK');

      if (data.steps && Array.isArray(data.steps) && data.steps.length){
        const ev = new CustomEvent('chat-steps', {detail: {steps: data.steps}});
        window.dispatchEvent(ev);
      }
    } catch (e){
      addMsg('bot', 'Communication error.');
    } finally {
      btn.disabled = false;
      input.focus();
    }
  }

  function send(){
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';
    return sendText(msg, {silentUser: false});
  }

  // Public API used by forms (e.g., after upload)
  window.ChatWidget = window.ChatWidget || {};
  window.ChatWidget.send = function(text){ return sendText(text, {silentUser: false}); };
  window.ChatWidget.sendSystem = function(text){ return sendText(text, {silentUser: true}); };

  btn.addEventListener('click', send);
  input.addEventListener('keydown', function(e){
    if (e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // Initial greeting
  if (ctx === 'ci') {
    addMsg('bot', 'Salut! Te ajut cu cererea pentru CI. Incarca documente si voi incerca sa completez automat campuri.');
  } else if (ctx === 'social') {
    addMsg('bot', 'Salut! Te ajut cu cererea pentru Ajutor Social. Incarca documente si voi incerca sa completez automat campuri.');
  } else if (ctx === 'operator') {
    addMsg('bot', 'Salut! Spune-mi ce vrei sa faci ca operator.');
  } else {
    addMsg('bot', 'Salut! Pot sa te ghidez pentru CI sau Ajutor Social. Ce vrei sa rezolvi?');
  }
})();
</script>
